name: Bedrock Version Bump

on:
  workflow_dispatch:
    inputs:
      minecraftVersion:
        description: 'Bedrock Minecraft version (e.g., 1.21.124)'
        required: true
        type: string
      protocolVersion:
        description: 'Protocol version number (e.g., 860)'
        required: true
        type: string
      createPr:
        description: 'Create a pull request with the changes'
        required: false
        type: boolean
        default: true

jobs:
  bump-bedrock-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          cd tools/js
          npm install

      - name: Run version bump script
        run: |
          cd tools/js
          npm run version bedrock ${{ github.event.inputs.minecraftVersion }} ${{ github.event.inputs.protocolVersion }}

      - name: Build protocol files
        run: |
          cd tools/js
          npm run build

      - name: Run tests
        run: |
          cd tools/js
          npm test

      - name: Create Pull Request
        if: ${{ github.event.inputs.createPr == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_PASSWORD || secrets.GITHUB_TOKEN }}
          commit-message: |
            Add bedrock ${{ github.event.inputs.minecraftVersion }} protocol data

            Updates:
            - Protocol version â†’ ${{ github.event.inputs.protocolVersion }}
            - Minecraft version â†’ ${{ github.event.inputs.minecraftVersion }}
            - Moved previous proto.yml to versioned folder
            - Updated protocolVersions.json, versions.json, and dataPaths.json
            - Regenerated protocol.json files
          branch: bedrock-bump-${{ github.event.inputs.minecraftVersion }}
          delete-branch: true
          title: Add bedrock ${{ github.event.inputs.minecraftVersion }} data
          body: |
            ## Bedrock Version Bump

            This PR adds support for Minecraft Bedrock Edition version **${{ github.event.inputs.minecraftVersion }}** with protocol version **${{ github.event.inputs.protocolVersion }}**.

            ### Changes
            - âœ… Protocol version bumped to ${{ github.event.inputs.protocolVersion }}
            - âœ… Minecraft version updated to ${{ github.event.inputs.minecraftVersion }}
            - âœ… Previous proto.yml files moved to versioned folder
            - âœ… Updated protocolVersions.json and versions.json
            - âœ… Regenerated all protocol.json files
            - âœ… All tests passing

            ### How this was generated
            This PR was automatically generated using the bedrock version bump workflow.

            ---
            ðŸ¤– Generated by GitHub Actions workflow
          labels: |
            bedrock
            version-bump
            automated
